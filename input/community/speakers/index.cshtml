@{
    Layout = @"_Layout.cshtml";
}

@section head {
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js" data-no-mirror></script>
}

<section class="page-section" id="speakers">
    <div class="page-section_container container">
        <div class="page-section_row row">
            <div class="col-12">
                <div>
                    @if (Context.ContainsKey("AzureMapsSubscriptionKey"))
                    {
                        <div id="location-map" class="mb-4"></div>
                    }
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label">Search</label>
                        <div class="col-sm-10">
                            <input type="text" class="search form-control-plaintext border" placeholder="Search names, locations, and tags">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label">Sort</label>
                        <div class="col-sm-10">
                            <button class="sort btn btn-primary" data-sort="speakername">Name</button>
                            <button class="sort btn btn-primary" data-sort="speakerlocation">Location</button>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label">Filter By Tag</label>
                        <div class="col-sm-10" id="tag-filters">
                            @foreach(string tag in OutputPages["community/speakers/*.html"].Where(x => !x.IdEquals(Document)).SelectMany(x => x.GetList<string>("Tags")).Distinct().OrderBy(x => x))
                            {
                                <a class="filter btn btn-light mb-2" href="javascript:void(0)" data-filter="@tag">@tag</a>
                            }
                        </div>
                    </div>
                </div>
                <div class="row list">
                    @foreach(IDocument speaker in OutputPages["community/speakers/*.html"].Where(x => !x.IdEquals(Document)))
                    {
                        <div class="col-sm-6 col-md-4 profile list__item">
                            @if (speaker.ContainsKey("Image"))
                            {
                                <img height="120" class="rounded-image profile-image" alt="@speaker.GetTitle()" src="assets/speakers/@speaker.GetString("Image")">
                            }
                            else
                            {
                                <img height="120" class="rounded-image profile-image" alt="@speaker.GetTitle()" src="img/dot_bot.png">
                            }

                            <h3 class="profile-name"><a href="@Context.GetLink(speaker)" class="speakername">@speaker.GetTitle()</a></h3>
                            <div class="d-none speakerlink">@Context.GetLink(speaker)</div>

                            @if (speaker.ContainsKey("Location"))
                            {
                                <div class="profile-details font-weight-bold speakerlocation">@speaker.GetString("Location")</div>
                            }
                            @if (speaker.ContainsKeys("Lat", "Lon"))
                            {
                                <div class="d-none speakerlat">@speaker.GetString("Lat")</div>
                                <div class="d-none speakerlon">@speaker.GetString("Lon")</div>                                
                            }

                            @if (speaker.ContainsKey("Tags"))
                            {
                                <div class="profile-details">
                                    @foreach(string tag in speaker.GetList<string>("Tags"))
                                    {
                                        <span class="pr-2"><a href="javascript:void(0)" class="filter btn btn-dark" data-filter="@tag">@tag</a></span>
                                    }
                                </div>
                                <div class="d-none speakertags">@string.Join("|", speaker.GetList<string>("Tags"))</div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    function filterTags(tag) {
        var filterButton = $('#tag-filters .filter[data-filter="' + tag + '"]');
        
        if(filterButton.hasClass('active')) {
            speakers.filter();
            $('.filter').removeClass('active');
        } else {
            speakers.filter(function(item) {
                if (item.values().speakertags.indexOf('|') > 0) {
                    return item.values().speakertags.split('|').includes(tag)
                } else {
                    return (item.values().speakertags == tag);
                }
            });
            $('.filter').removeClass('active');
            filterButton.addClass('active');
        }
    }

    var options = {
        valueNames: [ 'speakername', 'speakerlink', 'speakerlocation', 'speakerlat', 'speakerlon', 'speakertags' ]
    };
    var speakers = new List('speakers', options);

    $(document).ready(function() {
        speakers.sort('speakername', {
            sortFunction: function(itemA, itemB, options) {
                return 0.5 - Math.random();
            }
        });

        var queryParams = new URLSearchParams(window.location.search);
        var tagParam = queryParams.get('tag');
        if (tagParam) {
            filterTags(tagParam);
        }
    });

    $('.filter').on('click', function() {
        var tag = $(this).attr('data-filter');
        filterTags(tag);
    });
</script>

@if (Context.ContainsKey("AzureMapsSubscriptionKey"))
{
    <script>
        function updateMap(map, list) {
            map.markers.clear();
            $.each(list.matchingItems, function(index, item) {
                if (item.values().speakerlon && item.values().speakerlat) {
                    var popupContent = '<div style="padding:10px"><div><a href="' + item.values().speakerlink + '">' + item.values().speakername + '</a></div>';
                    if (item.values().speakerlocation) {
                        popupContent = popupContent + '<div>' + item.values().speakerlocation + '</div>';
                    }
                    popupContent = popupContent + '</div>';
                    var marker = new atlas.HtmlMarker({
                        color: 'DodgerBlue',
                        position: [item.values().speakerlon, item.values().speakerlat],
                        popup: new atlas.Popup({
                            content: popupContent,
                            pixelOffset: [0, -30]
                        })
                    });
                    map.markers.add(marker);
                    map.events.add('click', marker, () => {
                        marker.togglePopup();
                    });
                }
            });
        }

        $(document).ready(function() {
            var map = new atlas.Map('location-map', {
                zoom: 1,
                language: 'en-US',
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: '@Context.GetString("AzureMapsSubscriptionKey")'
                }}
            );            
            speakers.on('updated', function(list) {
                updateMap(map, list);
            });
            updateMap(map, speakers);
        });
    </script>
}